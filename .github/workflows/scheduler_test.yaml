name: Run Scheduler Tests
on: [workflow_dispatch]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8"]
        
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v0'
        with:
          workload_identity_provider: 'projects/959426188245/locations/global/workloadIdentityPools/github-action-pool-1/providers/github-action-provider-1'
          service_account: 'artifact-repository-access@roomr-222721.iam.gserviceaccount.com'
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v0'
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet
      - name: Checkout Redis Repo
        uses: actions/checkout@v3
        with:
         repository: sneyd321/Redis-docker-kubernetes
         path: Redis-docker-kubernetes
       
      - name: Run Docker
        run: |
          docker build -t sneyd321/redis ./Redis-docker-kubernetes
          gcloud iam service-accounts keys create ServiceAccount.json --iam-account=scheduler@roomr-222721.iam.gserviceaccount.com
          gcloud projects add-iam-policy-binding roomr-222721 --member="serviceAccount:scheduler@roomr-222721.iam.gserviceaccount.com" --role="roles/container.serviceAgent"
          docker build -t sneyd321/scheduler .
          docker run --name=redis -d -p6379:6379 sneyd321/redis
          docker run --name=scheduler -d sneyd321/scheduler
      - name: Test with pytest
        run: |
          docker exec scheduler-scheduler-1 pytest tests/test_scheduler.py
      - name: Delete Service Account Key
        if: always()
        run: |
          python remove_key.py
